<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>내 현재 위치 보기 — 진단 모드</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{background:#0d1117;color:#e6edf3;font-family:system-ui, -apple-system, "Noto Sans KR", sans-serif;margin:0;padding:20px;text-align:center}
    h1{color:#58a6ff;margin:0 0 12px}
    #info{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;display:inline-block;text-align:left;min-width:320px}
    #console{margin-top:12px;text-align:left;max-width:900px;white-space:pre-wrap;font-family:monospace;font-size:13px;color:#ffdcdc}
    #map{width:90%;max-width:900px;height:400px;margin:18px auto;border-radius:10px;overflow:hidden}
    .btn{margin-top:10px;padding:8px 12px;border-radius:8px;border:none;background:#238636;color:white;cursor:pointer}
    .warn{color:#ffb86b}
  </style>
</head>
<body>
  <h1>내 현재 위치 보기 — 진단 모드</h1>
  <div id="info">
    <div id="status">💡 페이지 로드: 위치 요청을 자동으로 시도합니다...</div>
    <div style="margin-top:8px">
      <button class="btn" id="retryBtn">다시 권한 요청하기</button>
      <button class="btn" id="showConsoleBtn" style="background:#0b5fff">콘솔 열어 안내 보기</button>
    </div>
    <div style="margin-top:8px;font-size:13px;color:#9aa4b2">
      (참고) GitHub Pages는 HTTPS여야 권한창이 뜹니다. 확실히 HTTPS로 접속했는지 확인하세요.
    </div>
  </div>

  <div id="map"></div>

  <div id="console" aria-live="polite"></div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 유틸: 화면 + 콘솔에 로그 남기기
    const logEl = document.getElementById('console');
    function log(...args){
      console.log(...args);
      const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
      logEl.textContent += s + "\\n";
    }
    function setStatus(txt, isWarn){
      const st = document.getElementById('status');
      st.innerHTML = (isWarn ? '<span class=\"warn\">' + txt + '</span>' : txt);
      log('STATUS:', txt);
    }

    // 지도 초기화 (빈 뷰)
    let map = L.map('map', { center: [20, 0], zoom: 2, attributionControl: false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    let marker;

    async function requestLocation(showPopupImmediately = true){
      setStatus('📡 위치 권한 요청 중...');
      log('navigator.geolocation supported?', !!navigator.geolocation);

      if(!navigator.geolocation){
        setStatus('❌ 이 브라우저는 Geolocation을 지원하지 않습니다.', true);
        return;
      }

      // 옵션: 최대 15초 대기, 정확도 허용
      const opts = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;
          setStatus(`✅ 위치 획득: 위도 ${lat.toFixed(6)}, 경도 ${lon.toFixed(6)} (정확도 ±${Math.round(acc)}m)`);
          log('POSITION SUCCESS', pos);
          if(marker) marker.setLatLng([lat, lon]);
          else marker = L.marker([lat, lon]).addTo(map);
          map.setView([lat, lon], 15);
          if(showPopupImmediately) marker.bindPopup('📍 현재 위치').openPopup();
        },
        (err) => {
          // 에러 코드 해석
          const codes = {1:'권한 거부(PERMISSION_DENIED)',2:'위치 정보 제공 불가(POSITION_UNAVAILABLE)',3:'요청 시간 초과(TIMEOUT)'};
          const msg = codes[err.code] || '알 수 없는 에러';
          setStatus('🚫 위치 정보를 가져올 수 없습니다: ' + msg, true);
          log('POSITION ERROR', err);
          // 추가 안내
          if(err.code === 1){
            log('권한 거부: 브라우저의 사이트 권한(또는 OS 설정)에서 위치 사용을 허용하세요.');
          } else if(err.code === 2){
            log('위치 제공 불가: 디바이스의 위치 서비스(GPS)가 꺼져있을 수 있습니다.');
          } else if(err.code === 3){
            log('타임아웃: 위치 탐색에 시간이 걸렸습니다. 다시 시도하세요.');
          }
        },
        opts
      );
    }

    // 자동 시도 (페이지 로드 직후)
    window.addEventListener('load', ()=> {
      log('페이지 로드 - 자동으로 위치 요청 시도');
      // 자동 시도 후에도 권한 팝업이 뜨지 않으면 retry 버튼 사용
      requestLocation(false);
    });

    // 버튼 연결
    document.getElementById('retryBtn').addEventListener('click', ()=> {
      log('사용자 요청: 다시 권한 요청');
      requestLocation(true);
    });
    document.getElementById('showConsoleBtn').addEventListener('click', ()=> {
      alert('브라우저 개발자 도구(F12) → Console 탭을 열어 추가 에러를 확인하세요. 여기 출력창에도 로그를 남겼습니다.');
    });

    // 유저에게 바로 보일 수 있는 짧은 도움말
    log('진단 시작:\\n1) HTTPS로 접속중인지 확인하세요.\\n2) 팝업이 안 뜨면 브라우저 주소창 옆에 자물쇠 아이콘 클릭 → 사이트 설정 → 위치 허용으로 바꿔보세요.\\n3) 확장 프로그램(예: 트래커 차단)이 위치 권한을 막을 수 있습니다. 일시적으로 비활성화하고 재시도하세요.');
  </script>
</body>
</html>
